# SmartCity Monorepo - Cursor AI Rules

## 프로젝트 구조
- **언어**: TypeScript
- **패키지 매니저**: pnpm
- **모노레포**: bushub-client

## 핵심 개발 규칙

### 백엔드 (Fastify만 사용)
- **프레임워크**: Fastify (Express 금지)
- **데이터베이스**: mongoose
- **로깅**: winston (메인), pino (Fastify 내부용)
- **로그 관리**: winston-daily-rotate-file로 일별 로그 분할
- **로그 형식**: JSON (파일), 컬러 콘솔 (개발환경)
- **아키텍처**: Clean Architecture + Repository Pattern
- **API 설계**: POST 사용 (PATCH 대신), 단수형 엔드포인트 (/errors/schema)
- **에러 처리**: try-catch, 표준화된 응답 형식
- **함수명**: 간결한 함수명 사용 (logSystemEventWithoutRequest 대신 logSystemEvent)
- **Modbus 통신**: UnifiedModbusService 사용
- **폴링 시스템**: MAPPED_ONLY 전용, 즉시 저장
- **의존성 주입**: ServiceContainer 사용

### 프론트엔드 (React + Vite)
- **빌드 도구**: Vite
- **UI 라이브러리**: shadcn/ui 우선
- **아이콘**: lucide-react
- **API 호출**: useApi.ts 훅 사용
- **API 정책**: 내부 API만 호출, 외부 API는 백엔드에서 처리
- **인증 관리**: React Context 사용
- **시간 형식**: 24시간 HH:mm (AM/PM 금지)
- **아바타 배경**: getUserBgColor 함수 사용
- **헬퍼 함수**: @smartcityMetaHelpers.tsx의 헬퍼 함수 우선 사용
- **상태 관리**: Hook 패턴, 각 유닛별 독립적 CommandManager
- **데이터 우선순위**: API 응답 > Local State

### 공통 컴포넌트
- **우선순위**: 각 프로젝트 내부 컴포넌트 먼저 사용
- **커스텀 컴포넌트**: 각 프로젝트 내부 components/common

## TypeScript & 린팅

### 공통 설정
- **타겟**: ES2020
- **strict 모드**: 활성화
- **모듈**: 백엔드(CommonJS), 프론트엔드(ESNext)
- **JSX**: react-jsx

### 프로젝트별 설정
- **bushub-client/backend**: noUnusedLocals: false, noUnusedParameters: false
- **bushub-client/frontend**: noUnusedLocals: true, noUnusedParameters: true

### ESLint 규칙
- **공통**: @typescript-eslint/recommended, unused-imports/no-unused-imports: error
- **프론트엔드**: react/recommended, react-hooks/recommended
- **Import 순서**: 알파벳 순, 그룹 분리

### Prettier 설정
- singleQuote: true, semi: true, tabWidth: 2, trailingComma: all, printWidth: 120

## 코딩 스타일

### 명명 규칙
- **변수/함수**: camelCase
- **클래스/인터페이스**: PascalCase (인터페이스는 I 접두사)
- **상수**: UPPER_SNAKE_CASE
- **파일/폴더**: kebab-case
- **컴포넌트**: PascalCase

### Import 규칙
- **순서**: builtin → external → internal → parent → sibling → index
- **그룹 분리**: newlines-between: always
- **알파벳 순**: caseInsensitive: true

### React 규칙
- **컴포넌트**: 화살표 함수 사용
- **Props**: 명시적 인터페이스 정의
- **Hook**: react-hooks 규칙 준수

## 특수 규칙

### Modbus 통신
- **설정**: 각 디바이스(unit)별 slaveId, baudRate, port
- **사용 범위**: 통합 HVAC 센서만, 다른 디바이스는 접점 제어
- **프로토콜**: manufacturer_deviceType 형식
- **통신 아키텍처**: UnifiedModbusService 사용
- **명령 큐**: 우선순위 기반 (high, normal, low)
- **폴링 모드**: MAPPED_ONLY 전용 (하드코딩 제거)
- **데이터 동기화**: 즉시 저장 방식 (버퍼링 없음)
- **에러 처리**: 재시도 메커니즘 (최대 1회, 100ms 지연)
- **성능 모니터링**: 폴링 통계 및 메모리 정리

### DDC 설정
- **하드웨어**: 승일 DDC 하드웨어 사양
- **포트**: DATA1-4 (RS-485), DO1-16 (디지털 출력)
- **프로토콜**: Modbus 장비만 설정 필요

### 환경 설정
- **.env 파일**: 수동 편집만, 자동 수정 금지
- **Docker 환경변수**: Dockerfile에 직접 설정 금지

### 보안 & 데이터 규칙
- **비밀번호**: GS 인증 표준 준수
- **API 키**: Bearer 토큰 인증 (admin_universal_key_2025)
- **권한 관리**: universal, internal, external 타입별 권한
- **엑셀 내보내기**: 탭 구분, 영어 헤더
- **파일 관리**: xlsx 선호 (csv 대신)
- **로깅**: 로그만 추가, 다른 코드 수정 금지

## UI/UX 가이드라인

### 디자인 원칙
- **간단함**: 직관적이고 깔끔한 디자인
- **일관성**: shadcn/ui 컴포넌트 우선 사용
- **반응형**: 모든 디바이스 지원
- **접근성**: a11y 고려
- **성능**: 불필요한 애니메이션 최소화

### 컴포넌트 사용 우선순위
1. **각 프로젝트 내부 컴포넌트** 먼저 사용
2. **shadcn/ui** 컴포넌트
3. **커스텀 컴포넌트** (각 프로젝트 내부 components/common)

## 테스트 전략

### 테스트 구조
- **단위 테스트**: Mock Repository 사용 (tests/unit/)
- **통합 테스트**: 실제 데이터베이스 연동 (tests/integration/)
- **패턴**: Given-When-Then 구조
- **커버리지**: 80% 이상 유지

### 테스트 실행
```bash
# 단위 테스트
pnpm test:unit

# 통합 테스트  
pnpm test:integration

# 전체 테스트
pnpm test
```

## 명령어

### 린팅
```bash
# bushub-client/frontend
pnpm lint          # ESLint 수정
pnpm lint:check    # ESLint 검사
pnpm type-check    # TypeScript 타입 검사

# bushub-client/backend
pnpm lint          # ESLint 수정
pnpm lint:check    # ESLint 검사
pnpm type-check    # TypeScript 타입 검사

# 전체 프로젝트
pnpm code-quality  # lint + format + type-check
```

### Docker
- **빌드 방식**: 환경변수 기반 조건부 빌드
- **환경 분리**: target: development/production으로 구분
- **환경변수**: 런타임 오버라이드 가능한 기본값 설정
- **리소스 제한**: 메모리/CPU 제한 설정
- **로그 관리**: JSON 로그 드라이버, 크기 제한
- **파일 분리**: docker-compose.dev.yml (개발), docker-compose.prod.yml (프로덕션)
- **실행 스크립트**: start-dev.sh (개발), start-prod.sh (프로덕션)
- **포트 분리**: 개발(4173/3000/27018/8081), 프로덕션(8080/3001/27017/80)
- **컨테이너명 분리**: 개발(-dev 접미사), 프로덕션(기본명)
- **데이터 분리**: db/data-dev (개발), db/data-prod (프로덕션)
- **동시 실행**: 개발환경과 프로덕션 환경 동시 실행 가능
- **업데이트**: update.sh - 컨테이너 업데이트
- **MongoDB**: start-mongodb-dev.sh - 개발용 MongoDB

## 커밋 메시지
- **형식**: [type] scope: message
- **예시**: [feat] auth: add login functionality

## 아키텍처 패턴

### Clean Architecture + Repository Pattern
- **Repository Layer**: 데이터 접근 로직을 인터페이스로 추상화
- **Service Layer**: 비즈니스 로직을 서비스에서 처리
- **Dependency Injection**: ServiceContainer를 통한 의존성 주입
- **Interface Segregation**: 각 레이어별 인터페이스 분리

### Modbus 통신 아키텍처
- **UnifiedModbusService**: Mock/실제 모드 통합 관리
- **Command Queue**: 우선순위 기반 명령 큐 (high, normal, low)
- **Polling System**: 매핑 기반 폴링 시스템 (MAPPED_ONLY 전용)
- **Data Sync**: 즉시 저장 방식 (버퍼링 제거)

### 프론트엔드 Hook 패턴
- **Custom Hooks**: 재사용 가능한 로직을 훅으로 분리
- **State Management**: React Context + Local State 조합
- **API Integration**: react-query 기반 데이터 페칭
- **Command Management**: 각 유닛별 독립적인 CommandManager

## 에러 처리 및 로깅

### 로깅 규칙
- **메인 로깅**: winston 사용 (winston-daily-rotate-file)
- **Fastify 로깅**: pino 사용 (내부용)
- **로그 레벨**: debug, info, warn, error
- **로그 형식**: JSON (파일), 컬러 콘솔 (개발환경)
- **로그 관리**: 일별 파일 분할, 14일 보관, 20MB 크기 제한

### 에러 분류
- **AppError**: 애플리케이션 레벨 에러
- **ValidationError**: 입력 검증 에러
- **SecurityError**: 보안 관련 에러
- **ProcessError**: 프로세스 레벨 에러

### 보안 검증
- **SQL Injection**: 정규식 패턴 검사
- **XSS**: 크로스 사이트 스크립팅 방지
- **Command Injection**: 명령어 주입 방지
- **NoSQL Injection**: NoSQL 주입 방지

## API 설계 규칙

### HTTP 메서드
- **POST 사용**: PATCH 대신 POST 사용
- **엔드포인트**: 단수형 사용 (/errors/schema)
- **RESTful**: REST 원칙 준수

### 스키마 검증
- **Fastify Schema**: Fastify 스키마 기반 검증
- **입력 검증**: body, query, params 각각 검증
- **타입 안전성**: TypeScript 타입 정의

### 보안
- **CORS**: Cross-Origin Resource Sharing 설정
- **API 키**: Bearer 토큰 인증 (admin_universal_key_2025)
- **입력 검증**: 모든 입력값 검증
- **에러 응답**: 표준화된 에러 응답 형식

## 프론트엔드 상태 관리

### Hook 패턴
- **Custom Hooks**: 재사용 가능한 로직을 훅으로 분리
- **useApi**: API 호출 훅
- **useDashboardData**: 대시보드 데이터 훅
- **useUnitFormManagement**: 폼 관리 훅
- **useCommandManager**: 명령 관리 훅

### 상태 우선순위
- **API 응답 우선**: unit.data > unitForm
- **Cross-device 방지**: 각 유닛별 독립적 상태 관리
- **실시간 동기화**: 폴링 데이터와 로컬 상태 동기화

### CommandManager
- **유닛별 독립**: 각 유닛마다 독립적인 CommandManager
- **명령 실행**: 직접 명령 실행 (부모 컴포넌트 의존성 제거)
- **상태 관리**: 로딩, 성공, 에러 상태 관리

## 성능 최적화

### 메모리 관리
- **TTL 기반 캐시**: 5분마다 자동 캐시 정리
- **메모리 정리**: 10분마다 메모리 정리
- **캐시 통계**: 각 캐시 레벨별 사용량 모니터링

### 폴링 최적화
- **조건부 폴링**: 캐시 기반 장비 조회
- **즉시 저장**: 버퍼링 제거로 데이터 일관성 보장
- **재시도 메커니즘**: 최대 1회, 100ms 지연

### API 호출 최적화
- **중복 실행 방지**: 동일한 명령 중복 실행 방지
- **스마트 캐싱**: react-query 기반 캐싱
- **리소스 제한**: Docker 리소스 제한 설정

## 프론트엔드 아키텍처 패턴

### Hook 패턴
- **Custom Hooks**: 재사용 가능한 로직을 훅으로 분리
- **useUnitFormManagement**: 폼 상태 관리 및 동기화
- **useCommandManager**: 명령 실행 및 상태 관리
- **useApi**: API 호출 및 에러 처리
- **useWebSocket**: 실시간 통신 관리
- **usePollingStatus**: 폴링 상태 모니터링

### Context 패턴
- **AuthContext**: 인증 상태 및 사용자 정보 관리
- **ClientContext**: 클라이언트 정보 및 선택 상태
- **LogContext**: 로그 패널 및 실시간 로그 관리
- **ApiKeyContext**: API 키 및 토큰 관리

### Component 분리
- **DeviceCard**: 디바이스 정보 표시 및 제어
- **UnitCard**: 유닛 정보 표시 및 설정
- **CommandRenderer**: 명령별 UI 렌더링
- **HardwareControlTabs**: 하드웨어 제어 탭 관리
- **SystemSettingsCard**: 시스템 설정 카드

### API 통합
- **React Query**: useMutation, useQuery 패턴 사용
- **에러 처리**: 표준화된 에러 응답 처리
- **로딩 상태**: isLoading, isPending 상태 관리
- **캐싱 전략**: staleTime, refetchOnWindowFocus 설정

## 백엔드 아키텍처 패턴

### Service Container
- **ServiceContainer**: 의존성 주입 컨테이너
- **인터페이스 기반**: ILogger, IModbusService 등 추상화
- **서비스 등록**: 생성자에서 서비스 등록 및 초기화

### Repository Pattern
- **인터페이스 분리**: IApiKeyRepository, IClientRepository 등
- **데이터 추상화**: MongoDB 구현체와 인터페이스 분리
- **테스트 지원**: Mock Repository 구현

### Command Pattern
- **CommandExecutionStrategy**: 명령 실행 전략
- **CommandQueue**: 우선순위 기반 명령 큐
- **CommandLog**: 명령 실행 로그 및 상태 추적

### Factory Pattern
- **ServiceFactoryMock**: 테스트용 서비스 팩토리
- **Mock/Real 전환**: 환경별 서비스 구현체 선택

## 데이터 동기화 규칙

### 폴링 데이터 우선순위
- **API 응답 우선**: unit.data > unitForm
- **실시간 동기화**: 폴링 데이터와 로컬 상태 동기화
- **Cross-device 방지**: 각 유닛별 독립적 상태 관리

### WebSocket 통신
- **실시간 업데이트**: LogMessage, CommandStatusMessage
- **연결 상태 관리**: 재연결 메커니즘 및 에러 처리
- **메시지 타입**: 로그, 명령 상태 분리

### 폼 상태 관리
- **useUnitFormManagement**: 선택된 유닛의 폼 상태 관리
- **동기화 로직**: unit.data 변경 시 unitForm 자동 동기화
- **의존성 배열**: JSON.stringify를 통한 객체 변경 감지

## 에러 처리 표준

### 백엔드 에러 처리
- **표준화된 응답**: createSuccessResponse, createErrorResponse
- **에러 분류**: AppError, ValidationError, SecurityError, ProcessError
- **로깅**: winston 기반 구조화된 로그

### 프론트엔드 에러 처리
- **HardwareControlError**: 하드웨어 제어 에러 타입
- **에러 토스트**: 사용자 친화적 에러 메시지
- **에러 복구**: 재시도 메커니즘 및 폴백 처리

### API 에러 응답
- **표준 형식**: { success: boolean, message: string, data?: T, error?: { code: string, message: string } }
- **HTTP 상태 코드**: 적절한 상태 코드 사용
- **에러 메시지**: 한국어 에러 메시지

## 성능 최적화 가이드

### React 최적화
- **메모이제이션**: React.memo, useMemo, useCallback 사용
- **지연 로딩**: Suspense와 lazy 컴포넌트
- **가상화**: 대용량 데이터 처리를 위한 최적화

### API 최적화
- **중복 실행 방지**: 동일한 명령 중복 실행 방지
- **스마트 캐싱**: react-query 기반 캐싱
- **배치 처리**: 여러 명령을 한 번에 처리

### 메모리 관리
- **TTL 기반 캐시**: 5분마다 자동 캐시 정리
- **메모리 정리**: 10분마다 메모리 정리
- **캐시 통계**: 각 캐시 레벨별 사용량 모니터링

## 보안 검증 규칙

### 입력 검증
- **Zod 스키마**: validationSchemas.ts의 타입 안전한 검증
- **SQL Injection**: 정규식 패턴 검사
- **XSS 방지**: 크로스 사이트 스크립팅 방지
- **Command Injection**: 명령어 주입 방지
- **NoSQL Injection**: NoSQL 주입 방지

### 인증 및 권한
- **API 키 관리**: Bearer 토큰 인증
- **권한 관리**: universal, internal, external 타입별 권한
- **세션 관리**: React Context 기반 상태 관리

### 데이터 보호
- **비밀번호**: GS 인증 표준 준수
- **민감 정보**: 환경변수로 관리
- **로깅**: 민감 정보 제외한 로그

## UI/UX 패턴

### 반응형 디자인
- **useIsMobile**: 모바일 감지 훅
- **브레이크포인트**: Tailwind CSS 반응형 클래스
- **적응형 레이아웃**: 화면 크기별 최적화

### 접근성 (a11y)
- **aria-label**: 스크린 리더 지원
- **role 속성**: 시맨틱 역할 정의
- **키보드 네비게이션**: 탭 순서 및 포커스 관리

### 사용자 피드백
- **로딩 상태**: LoadingPanel, ProcessDialog
- **에러 메시지**: 토스트 알림 및 인라인 에러
- **성공 피드백**: 작업 완료 시각적 피드백

### 컴포넌트 일관성
- **shadcn/ui**: 표준 UI 컴포넌트 우선 사용
- **테마 시스템**: 일관된 색상 및 스타일
- **아이콘**: lucide-react 통일

## 개발 도구 설정

### TypeScript 설정
- **exactOptionalPropertyTypes**: true (엄격한 옵셔널 속성 체크)
- **strict 모드**: 활성화
- **타입 안전성**: 모든 API 응답 타입 정의

### 환경별 설정
- **setup.pc.config.ts**: PC별 설정 관리
- **환경변수**: VITE_ 접두사 사용
- **개발/프로덕션**: 환경별 빌드 설정

### 코드 품질
- **ESLint**: @typescript-eslint/recommended
- **Prettier**: 일관된 코드 포맷팅
- **Import 순서**: 알파벳 순, 그룹 분리

## 데이터 흐름 관리

### 상태 관리 패턴
- **React Context**: 전역 상태 관리
- **Local State**: 컴포넌트별 로컬 상태
- **Server State**: React Query 기반 서버 상태

### 데이터 변환
- **userDataProcessor.ts**: 사용자 데이터 가공
- **smartcityMetaHelpers.tsx**: 메타데이터 헬퍼 함수
- **format.ts**: 데이터 포맷팅 유틸리티

### 실시간 동기화
- **WebSocket**: 실시간 통신
- **Polling**: 주기적 데이터 갱신
- **하이브리드**: WebSocket + Polling 조합

## 수정 금지 파일
- `.github/workflows/deploy-ghcr.yml`
- `.github/workflows/mirror-images.yml`
- **이유**: CI/CD 파이프라인 자동화 파일 