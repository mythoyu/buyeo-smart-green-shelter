name: Deploy USB Package

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  create-usb-package:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.17.0"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.13.1

      - name: Install dependencies
        run: pnpm install

      - name: Build project
        run: pnpm run build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry (for mirrored base images)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend and frontend Docker images (version tags)
        run: |
          echo "ğŸ³ Building Docker images for offline USB..."
          # Build backend image
          docker build \
            -f packages/bushub-client/backend/Dockerfile \
            -t bushub-backend:${{ github.ref_name }} \
            .

          # Build frontend image
          docker build \
            -f packages/bushub-client/frontend/Dockerfile \
            -t bushub-frontend:${{ github.ref_name }} \
            .

      - name: Save Docker Images
        run: |
          echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ì €ì¥ ì¤‘..."
          mkdir -p docker-images

          # ê³µê°œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì—ì„œ pull
          docker pull mongo:6.0.15
          docker pull nginx:1.28.0

          # ê°„ë‹¨í•œ ì´ë¦„ìœ¼ë¡œ ì €ì¥ (docker-compose.integrated.ymlê³¼ ì¼ì¹˜)
          docker save -o docker-images/mongo-6.0.15.tar mongo:6.0.15
          docker save -o docker-images/nginx-1.28.0.tar nginx:1.28.0

          # í”„ë¡œì íŠ¸ ì´ë¯¸ì§€ ì €ì¥ (ì˜¤í”„ë¼ì¸ìš©)
          docker save -o docker-images/bushub-backend.${{ github.ref_name }}.tar bushub-backend:${{ github.ref_name }}
          docker save -o docker-images/bushub-frontend.${{ github.ref_name }}.tar bushub-frontend:${{ github.ref_name }}

          echo "âœ… Docker ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ"
          ls -la docker-images/

      - name: Build Network Control API bundle (offline)
        run: |
          echo "ğŸ“¦ Building Network Control API bundle for offline install..."
          pushd packages/bushub-client/network-control-api

          # npmì„ ì‚¬ìš©í•˜ì—¬ ì‹¬ë³¼ë¦­ ë§í¬ ë¬¸ì œ í•´ê²°
          echo "ğŸ”§ npmì„ ì‚¬ìš©í•˜ì—¬ ì˜ì¡´ì„± ì„¤ì¹˜ (ì‹¬ë³¼ë¦­ ë§í¬ ì—†ìŒ)..."
          npm install --production
          npm run build

          # ë²ˆë“¤ ìƒì„±: dist + node_modules + package.json
          mkdir -p ../../../nca-bundle
          tar -czf ../../../nca-bundle/nca-bundle.tar.gz \
            dist node_modules package.json
          popd

      - name: Create USB Package (minimal offline contents)
        run: |
          echo "Creating USB package with tag: ${{ github.ref_name }}"

          # ë£¨íŠ¸: usb-installer.sh
          mkdir -p usb-package
          cp packages/bushub-client/usb-installer.sh usb-package/
          chmod +x usb-package/usb-installer.sh

          # ëŸ°íƒ€ì„ íŒŒì¼: packages/bushub-client ì•„ë˜ ìµœì†Œ êµ¬ì„±ë§Œ ë°°ì¹˜
          mkdir -p usb-package/packages/bushub-client
          cp packages/bushub-client/docker-compose.integrated.yml usb-package/packages/bushub-client/
          cp packages/bushub-client/deploy-hybrid.sh usb-package/packages/bushub-client/
          chmod +x usb-package/packages/bushub-client/deploy-hybrid.sh

          # nginx ì„¤ì •
          mkdir -p usb-package/packages/bushub-client/nginx
          cp packages/bushub-client/nginx/nginx.conf usb-package/packages/bushub-client/nginx/
          cp packages/bushub-client/nginx/mime.types usb-package/packages/bushub-client/nginx/

          # systemd ì„œë¹„ìŠ¤ íŒŒì¼
          mkdir -p usb-package/packages/bushub-client/scripts
          cp packages/bushub-client/scripts/bushub-network-control-api.service usb-package/packages/bushub-client/scripts/

          # ìš´ì˜ ìœ í‹¸ ìŠ¤í¬ë¦½íŠ¸(tools) - USB_ROOT/tools ë¡œ ë°°ì¹˜
          mkdir -p usb-package/tools
          if [ -d packages/bushub-client/tools ]; then
            cp -r packages/bushub-client/tools/* usb-package/tools/
            chmod 755 usb-package/tools
            find usb-package/tools -type f -name "*.sh" -exec chmod +x {} \;
          fi

          # Docker ì´ë¯¸ì§€ë“¤
          cp -r docker-images usb-package/packages/bushub-client/

          # Network Control API ë²ˆë“¤
          mkdir -p usb-package/packages/bushub-client/network-control-api
          cp nca-bundle/nca-bundle.tar.gz usb-package/packages/bushub-client/network-control-api/

          # ì••ì¶• íŒŒì¼ ìƒì„±
          echo "ğŸ—œï¸ Creating compressed package..."
          tar -czf bushub-smartcity-${{ github.ref_name }}.tar.gz -C usb-package .

          # íŒŒì¼ ê²€ì¦
          if [ ! -f "bushub-smartcity-${{ github.ref_name }}.tar.gz" ]; then
            echo "Error: USB package file not created"
            exit 1
          fi

          echo "USB package created successfully:"
          ls -la bushub-smartcity-${{ github.ref_name }}.tar.gz

          # ì••ì¶• íŒŒì¼ ë‚´ìš© ê²€ì¦
          echo "ğŸ“‹ Package contents:"
          tar -tzf bushub-smartcity-${{ github.ref_name }}.tar.gz | head -20

          echo "USB package validation passed"

      - name: Create GitHub Release and upload USB package
        uses: softprops/action-gh-release@v1
        with:
          files: bushub-smartcity-${{ github.ref_name }}.tar.gz
          tag_name: ${{ github.ref_name }}
          name: USB Package ${{ github.ref_name }}
          body: |
            ## SmartCity Application Package ${{ github.ref_name }}

            ### ì‚¬ìš©ë²•
            1. íŒŒì¼ ë‹¤ìš´ë¡œë“œ: `bushub-smartcity-${{ github.ref_name }}.tar.gz`
            2. USBì— ë³µì‚¬ í›„ ë¦¬ëˆ…ìŠ¤ PCì—ì„œ ì••ì¶• í•´ì œ: `tar -xzf bushub-smartcity-${{ github.ref_name }}.tar.gz`
            3. ì„¤ì¹˜ ì‹¤í–‰: `sudo ./usb-installer.sh`
               - ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œ: `jecs` (JECS-N100B ì œí’ˆ ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸)
            4. ì›¹ ì ‘ì†: http://localhost

            ### ì„¤ì¹˜ ê³¼ì •
            1. **USB íŒ¨í‚¤ì§€ ì¤€ë¹„**:
               ```bash
               # USBì— íŒŒì¼ ë³µì‚¬ í›„ ë¦¬ëˆ…ìŠ¤ PCì—ì„œ
               tar -xzf bushub-smartcity-${{ github.ref_name }}.tar.gz
               sudo ./usb-installer.sh
               # ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œ: jecs (JECS-N100B ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸)
               ```

            2. **ìë™ ì„¤ì¹˜ ê³¼ì •** (`usb-installer.sh`ê°€ ì²˜ë¦¬):
               - **ì˜ì¡´ì„± í™•ì¸**: Docker, Docker Compose, Node.js ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
               - **ì˜ì¡´ì„± ì„¤ì¹˜** (í•„ìš”ì‹œ, ì¸í„°ë„· ì—°ê²° í•„ìš”):
                 - Docker ì„¤ì¹˜
                 - Docker Compose ì„¤ì¹˜  
                 - Node.js ì„¤ì¹˜
               - **ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì¹˜** (ì˜¤í”„ë¼ì¸):
                 - Docker ì´ë¯¸ì§€ ë¡œë“œ
                 - Network Control API ì„¤ì¹˜
                 - ì„œë¹„ìŠ¤ ì‹œì‘

            3. **ì™„ë£Œ**:
               ```bash
               # ì›¹ ì ‘ì†
               http://localhost
               ```

            ### í¬í•¨ëœ êµ¬ì„±ìš”ì†Œ
            - **ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¯¸ì§€**: backend:${{ github.ref_name }}, frontend:${{ github.ref_name }}, mongo:6.0.15, nginx:1.28.0
            - **Network Control API**: ì™„ì „í•œ ì˜¤í”„ë¼ì¸ ë²ˆë“¤ (dist + node_modules)
            - **ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸**: usb-installer.sh, deploy-hybrid.sh
            - **ì„¤ì • íŒŒì¼**: docker-compose.integrated.yml, nginx.conf, mime.types, systemd service

            ### ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
            - **í•˜ë“œì›¨ì–´**: JECS-N100B ì œí’ˆ (ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸: `jecs`)
            - **OS**: Linux (Ubuntu 20.04+)
            - **ë©”ëª¨ë¦¬**: 2GB RAM ì´ìƒ
            - **ì €ì¥ê³µê°„**: 5GB ë””ìŠ¤í¬ ê³µê°„
            - **ë„¤íŠ¸ì›Œí¬**: **ì´ˆê¸° ì„¤ì¹˜ ì‹œ ì¸í„°ë„· ì—°ê²° í•„ìš”** (Docker, Node.js ì„¤ì¹˜ìš©)
            - **ë™ì‘**: ì„¤ì¹˜ í›„ **ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œëŠ” ì˜¤í”„ë¼ì¸ ë™ì‘**

            ### ì¥ì 
            - **ì• í”Œë¦¬ì¼€ì´ì…˜ ì˜¤í”„ë¼ì¸**: ì„¤ì¹˜ í›„ ì¸í„°ë„· ì—°ê²° ì—†ì´ ë™ì‘
            - **ë²„ì „ ê³ ì •**: íŠ¹ì • íƒœê·¸ì˜ ì•ˆì •ëœ ë²„ì „
            - **ë¹ ë¥¸ ë°°í¬**: ì• í”Œë¦¬ì¼€ì´ì…˜ ë‹¤ìš´ë¡œë“œ ì‹œê°„ ì—†ìŒ
            - **ì¼ê´€ì„±**: ê°œë°œí™˜ê²½ê³¼ ë™ì¼í•œ êµ¬ì¡°
            - **USB ë°°í¬**: ë„¤íŠ¸ì›Œí¬ ì—†ëŠ” í™˜ê²½ì—ì„œë„ ë°°í¬ ê°€ëŠ¥
            - **ìŠ¤ë§ˆíŠ¸ ì„¤ì¹˜**: ì˜ì¡´ì„± ìë™ ê°ì§€ ë° ì„¤ì¹˜

            ### ë³´ì•ˆ
            - Private Repository: í—ˆê°€ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼
            - ì• í”Œë¦¬ì¼€ì´ì…˜ ì˜¤í”„ë¼ì¸: ì™¸ë¶€ API í˜¸ì¶œ ì—†ìŒ
            - ë²„ì „ ê³ ì •: ì˜ˆì¸¡ ê°€ëŠ¥í•œ ì„¤ì¹˜ í™˜ê²½
            - USB ë°°í¬: ë„¤íŠ¸ì›Œí¬ ë…¸ì¶œ ìµœì†Œí™”
          draft: false
          prerelease: false
