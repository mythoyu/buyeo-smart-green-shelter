# Multi-stage Dockerfile for Frontend
FROM node:18-alpine AS base

WORKDIR /app

# Use corepack to enable pnpm and pin version to lockfile's expectation
RUN corepack enable && corepack prepare pnpm@10.13.1 --activate

# Copy workspace configuration files
COPY pnpm-workspace.yaml ./
COPY package.json ./
COPY pnpm-lock.yaml ./

# Copy only frontend package files
COPY packages/bushub-client/frontend/package.json ./packages/bushub-client/frontend/
COPY packages/bushub-client/frontend/pnpm-lock.yaml ./packages/bushub-client/frontend/

# Install only frontend dependencies (workspace rootì—ì„œ ì‹¤í–‰)
RUN pnpm install --frozen-lockfile --filter @bushub-client/frontend

# Copy frontend source code
COPY packages/bushub-client/frontend ./packages/bushub-client/frontend

# Move to frontend directory
WORKDIR /app/packages/bushub-client/frontend

# Development stage
FROM base AS development

# curl ì„¤ì¹˜ (í—¬ìŠ¤ì²´í¬ìš©)
RUN apk add --no-cache curl

# ğŸ”„ ê°œë°œí™˜ê²½ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
ENV NODE_ENV=development \
    VITE_IS_LOCAL=false

EXPOSE 4173

# ê°œë°œ ëª¨ë“œ ì‹¤í–‰
CMD ["pnpm", "run", "dev", "--host", "0.0.0.0"]

# Production stage
FROM base AS production

# ğŸ”„ í”„ë¡œë•ì…˜ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
ENV NODE_ENV=production \
    VITE_IS_LOCAL=false

# Build the application for production
RUN pnpm run build:production

# Install nginx for production
RUN apk add --no-cache nginx && \
    mkdir -p /var/log/nginx && \
    mkdir -p /var/lib/nginx/tmp && \
    mkdir -p /usr/share/nginx/html && \
    chown -R nginx:nginx /var/log/nginx /var/lib/nginx /usr/share/nginx/html

EXPOSE 8080

# í”„ë¡œë•ì…˜ ëª¨ë“œ ì‹¤í–‰ (nginxë¡œ ì •ì  íŒŒì¼ ì„œë¹™)
CMD ["sh", "-c", "cp -r dist/* /usr/share/nginx/html/ && nginx -c /app/packages/bushub-client/frontend/nginx.conf -g 'daemon off;'"]